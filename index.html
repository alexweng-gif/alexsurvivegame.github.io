<!DOCTYPE html>
<html lang="zh-TW">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZQEXH5FLTJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZQEXH5FLTJ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野外生存 - 文字冒險遊戲</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4e8;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #556b2f;
            padding-bottom: 10px;
        }
        
        header h1 {
            color: #556b2f;
            margin-bottom: 5px;
        }
        
        #game-container {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        #output {
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        #stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .stats-panel {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f5f5f5;
            margin-right: 10px;
        }
        
        .stats-panel:last-child {
            margin-right: 0;
        }
        
        .stats-panel h3 {
            margin-top: 0;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            color: #556b2f;
        }
        
        #input-container {
            display: flex;
            margin-bottom: 15px;
        }
        
        #user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
        }
        
        button {
            background-color: #556b2f;
            color: white;
            border: none;
            padding: 8px 16px;
            margin-left: 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #455a27;
        }
        
        #actions-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .action-btn {
            padding: 10px;
            background-color: #789052;
        }
        
        .action-btn:hover {
            background-color: #68804a;
        }
        
        .progress-bar {
            height: 15px;
            background-color: #ddd;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.3s;
        }
        
        .health-fill {
            background-color: #ff6b6b;
        }
        
        .hunger-fill {
            background-color: #ffa94d;
        }
        
        .energy-fill {
            background-color: #4db6ac;
        }
        
        .water-fill {
            background-color: #4dabff;
        }
        
        .stat-value {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        /* 為彈出菜單添加樣式 */
        .popup-menu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .popup-title {
            margin-top: 0;
            color: #556b2f;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .popup-content {
            margin-bottom: 15px;
        }
        
        .popup-close {
            text-align: right;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .menu-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background-color: #e9e9e9;
        }
        
        .menu-item.available {
            border-left: 3px solid #556b2f;
        }
        
        .menu-item.unavailable {
            border-left: 3px solid #ccc;
            color: #999;
            cursor: not-allowed;
        }
        
        .time-display {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #556b2f;
            margin: 10px 0;
        }
        
        .day-display {
            margin-right: 20px;
        }
        
        .tutorial-text {
            line-height: 1.8;
        }
        
        .progress-text {
            font-weight: bold;
            color: #556b2f;
        }
        
        .weather-effect {
            font-style: italic;
            color: #555;
            margin-top: 5px;
        }
        
        .next-btn {
            background-color: #4CAF50;
            margin-top: 10px;
        }
        
        .end-game-container {
            text-align: center;
            padding: 20px;
        }
        
        .end-game-title {
            font-size: 24px;
            color: #556b2f;
            margin-bottom: 15px;
        }
        
        .end-game-stats {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .save-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .save-btn {
            background-color: #4a76a8;
        }
        
        .load-btn {
            background-color: #5e9ca0;
        }
        
        @media (max-width: 600px) {
            #stats-container {
                flex-direction: column;
            }
            
            .stats-panel {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            #actions-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .popup-menu {
                width: 90%;
                height: auto;
                max-height: 80vh;
            }
            
            body {
                padding: 10px;
            }
            
            #output {
                max-height: 280px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>野外生存</h1>
        <p>文字冒險遊戲</p>
    </header>
    
    <div id="game-container">
        <div class="save-actions">
            <button id="save-btn" class="save-btn">儲存遊戲</button>
            <button id="load-btn" class="load-btn">載入遊戲</button>
        </div>
        
        <div id="stats-container">
            <div class="stats-panel">
                <h3>玩家狀態</h3>
                <div class="stat-value">
                    <span>健康:</span>
                    <span id="health-value">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill health-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-value">
                    <span>飢餓:</span>
                    <span id="hunger-value">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill hunger-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-value">
                    <span>能量:</span>
                    <span id="energy-value">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill energy-fill" style="width: 100%"></div>
                </div>
                
                <div class="stat-value">
                    <span>口渴:</span>
                    <span id="water-value">100/100</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill water-fill" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="stats-panel">
                <h3>世界信息</h3>
                <div class="time-display">
                    <span class="day-display" id="day-display">第1天</span>
                    <span id="time-display">05:00</span>
                </div>
                <p><strong>天氣:</strong> <span id="weather-display">晴朗</span></p>
                <p id="weather-effect" class="weather-effect"></p>
                <p><strong>剩餘白天時間:</strong> <span id="remaining-time">19小時</span></p>
                <p><strong>位置:</strong> <span id="location-display">未知</span></p>
                <div id="quest-info">
                    <p><strong>當前任務:</strong> <span id="current-quest">生存基礎</span></p>
                    <p id="quest-desc">學習基本的生存技能，收集資源以製作工具</p>
                    <p id="quest-progress"></p>
                </div>
            </div>
        </div>
        
        <div id="output">你醒來發現自己身處荒野，必須想辦法生存下去...</div>
        
        <div id="input-container">
            <input type="text" id="user-input" placeholder="輸入指令或選擇下方選項...">
            <button id="submit-btn">確認</button>
        </div>
        
        <div id="actions-container">
            <button class="action-btn" data-action="gather">採集資源 (2小時)</button>
            <button class="action-btn" data-action="hunt">狩獵 (2小時)</button>
            <button class="action-btn" data-action="fish">釣魚 (2小時)</button>
            <button class="action-btn" data-action="water">尋找水源 (1小時)</button>
            <button class="action-btn" data-action="rest">休息 (回復體力)</button>
            <button class="action-btn" data-action="inventory">物品欄</button>
            <button class="action-btn" data-action="craft">製作工具 (1小時)</button>
            <button class="action-btn" data-action="tools">已裝備工具</button>
            <button class="action-btn" data-action="quest">查看任務</button>
            <button class="action-btn" data-action="explore">探索地點 (2小時)</button>
            <button class="action-btn" data-action="sleep">結束一天 (睡覺)</button>
            <button class="action-btn" data-action="help">遊戲教學</button>
        </div>
    </div>
    
    <!-- 彈出菜單 -->
    <div class="overlay" id="overlay"></div>
    
    <!-- 物品欄彈出視窗 -->
    <div class="popup-menu" id="inventory-menu">
        <h3 class="popup-title">物品欄</h3>
        <div class="popup-content" id="inventory-content">
            <!-- 這裡會動態填入物品內容 -->
        </div>
        <div class="popup-content">
            <p><strong>食物儲備總量:</strong> <span id="food-storage">0</span> 單位</p>
        </div>
        <div class="popup-close">
            <button id="use-item-btn">使用物品</button>
            <button id="inventory-close">關閉</button>
        </div>
    </div>
    
    <!-- 使用物品彈出視窗 -->
    <div class="popup-menu" id="use-item-menu">
        <h3 class="popup-title">使用物品</h3>
        <div class="popup-content" id="use-item-content">
            <!-- 這裡會動態填入可使用的物品 -->
        </div>
        <div class="popup-close">
            <button id="use-item-close">返回</button>
        </div>
    </div>
    
    <!-- 休息彈出視窗 -->
    <div class="popup-menu" id="rest-menu">
        <h3 class="popup-title">休息 (回復體力)</h3>
        <div class="popup-content">
            <p>休息可以回復能量，但會消耗食物和水分。</p>
            <p>你想休息多少小時？</p>
            <input type="number" id="rest-hours" min="1" max="19" value="1">
            <button id="rest-confirm">確認</button>
        </div>
        <div class="popup-close">
            <button id="rest-close">取消</button>
        </div>
    </div>
    
    <!-- 製作工具彈出視窗 -->
    <div class="popup-menu" id="craft-menu">
        <h3 class="popup-title">製作工具</h3>
        <div class="popup-content" id="craft-content">
            <!-- 這裡會動態填入可製作的工具 -->
        </div>
        <div class="popup-close">
            <button id="craft-close">關閉</button>
        </div>
    </div>
    
    <!-- 探索地點彈出視窗 -->
    <div class="popup-menu" id="explore-menu">
        <h3 class="popup-title">探索地點</h3>
        <div class="popup-content" id="explore-content">
            <!-- 這裡會動態填入可探索的地點 -->
        </div>
        <div class="popup-close">
            <button id="explore-close">關閉</button>
        </div>
    </div>
    
    <!-- 查看任務彈出視窗 -->
    <div class="popup-menu" id="quest-menu">
        <h3 class="popup-title">任務日誌</h3>
        <div class="popup-content" id="quest-content">
            <!-- 這裡會動態填入任務內容 -->
        </div>
        <div class="popup-close">
            <button id="quest-close">關閉</button>
        </div>
    </div>
    
    <!-- 已裝備工具彈出視窗 -->
    <div class="popup-menu" id="tools-menu">
        <h3 class="popup-title">已裝備工具</h3>
        <div class="popup-content" id="tools-content">
            <!-- 這裡會動態填入已裝備的工具 -->
        </div>
        <div class="popup-close">
            <button id="tools-close">關閉</button>
        </div>
    </div>
    
    <!-- 遊戲教學彈出視窗 -->
    <div class="popup-menu" id="help-menu">
        <h3 class="popup-title">遊戲教學</h3>
        <div class="popup-content tutorial-text">
            <p>歡迎來到野外生存!</p>
            <p>在這個遊戲中，你需要管理你的健康、飢餓、能量和水分等屬性。</p>
            
            <h4>基本操作</h4>
            <ul>
                <li><strong>採集資源</strong> - 獲取木頭、石頭等基本材料</li>
                <li><strong>狩獵</strong> - 獲取肉類食物</li>
                <li><strong>釣魚</strong> - 獲取魚類食物</li>
                <li><strong>尋找水源</strong> - 補充水分</li>
                <li><strong>休息</strong> - 恢復體力</li>
                <li><strong>結束一天</strong> - 睡覺並進入下一天</li>
            </ul>
            
            <h4>時間系統</h4>
            <ul>
                <li>每天早上5點起床</li>
                <li>白天時間為5:00~24:00，讓你有足夠時間活動</li>
                <li>每個行動都會消耗時間</li>
                <li>夜晚0:00~5:00必須休息</li>
            </ul>
            
            <h4>天氣影響</h4>
            <ul>
                <li><strong>晴朗</strong> - 正常活動</li>
                <li><strong>多雲</strong> - 採集效率略微下降</li>
                <li><strong>雨天</strong> - 能量消耗增加，但尋找水源更容易</li>
                <li><strong>雷暴</strong> - 大幅增加能量消耗，狩獵和釣魚效率降低，但可收集雨水</li>
            </ul>
            
            <h4>工具系統</h4>
            <ul>
                <li>製作工具可以提高相應活動的效率</li>
                <li>工具有耐久度，使用多次後會損壞</li>
                <li>不同工具對不同活動有加成</li>
            </ul>
            
            <h4>生存提示</h4>
            <ul>
                <li>優先保持飢餓度和口渴度，以免損失健康值</li>
                <li>合理安排時間活動</li>
                <li>在夜晚來臨前確保有足夠食物和水分</li>
                <li>完成任務獲取獎勵和推進遊戲</li>
            </ul>
        </div>
        <div class="popup-close">
            <button id="help-close">關閉</button>
        </div>
    </div>
    
    <!-- 玩家姓名輸入彈出視窗 -->
    <div class="popup-menu" id="name-menu" style="display: block;">
        <h3 class="popup-title">歡迎來到野外生存</h3>
        <div class="popup-content">
            <p>你醒來發現自己身處荒野，必須想辦法生存下去...</p>
            <p>請輸入你的名字：</p>
            <input type="text" id="player-name" placeholder="輸入你的名字">
        </div>
        <div class="popup-close">
            <button id="name-confirm">開始遊戲</button>
        </div>
    </div>
    
    <!-- 引導教學彈出視窗 -->
    <div class="popup-menu" id="tutorial-popup">
        <h3 class="popup-title">教學引導</h3>
        <div class="popup-content" id="tutorial-content">
            <!-- 動態填入教學內容 -->
        </div>
        <div class="popup-close">
            <button id="tutorial-next" class="next-btn">下一步</button>
            <button id="tutorial-close">跳過教學</button>
        </div>
    </div>
    
    <!-- 遊戲結束彈出視窗 -->
    <div class="popup-menu" id="end-game-menu">
        <div class="end-game-container">
            <h2 class="end-game-title">遊戲結束</h2>
            <div id="end-game-message"></div>
            <div class="end-game-stats" id="end-game-stats"></div>
            <button id="restart-btn">重新開始</button>
        </div>
    </div>
    
    <script>
        // 遊戲數據
        const game = {
            player: {
                name: "",
                health: 100,
                hunger: 100,
                energy: 100,
                water: 100,
                equippedTools: {},
                visitedLocations: [],
                skills: {
                    gathering: 1,
                    hunting: 1,
                    fishing: 1,
                    survival: 1
                }
            },
            world: {
                day: 1,
                hour: 5,
                minute: 0,
                weather: "晴朗",
                locations: ["森林", "河邊", "山洞", "廢棄小屋", "平原", "湖泊", "山脊", "峽谷"],
                currentLocation: "",
                weatherEffects: {
                    "晴朗": { energyMod: 1.0, waterMod: 1.2, gatherMod: 1.0, huntMod: 1.0, fishMod: 1.0 },
                    "多雲": { energyMod: 1.0, waterMod: 1.0, gatherMod: 0.9, huntMod: 1.0, fishMod: 0.9 },
                    "雨天": { energyMod: 1.3, waterMod: 0.5, gatherMod: 0.8, huntMod: 0.8, fishMod: 1.2 },
                    "雷暴": { energyMod: 1.5, waterMod: 0.3, gatherMod: 0.6, huntMod: 0.5, fishMod: 0.5 }
                }
            },
            inventory: {},
            tutorial: {
                active: false,
                step: 0,
                completed: false,
                steps: [
                    { 
                        title: "基本生存", 
                        text: "歡迎來到野外生存！讓我們先了解一下基本情況。\n\n右側的面板顯示了你的健康、飢餓、能量和口渴程度。如果飢餓或口渴值降為0，你將開始失去健康值。",
                        highlight: "#stats-container"
                    },
                    { 
                        title: "時間系統", 
                        text: "遊戲有時間系統。每天從早上5點開始，到24點結束。許多活動會消耗時間，請合理分配你的白天時間。",
                        highlight: "#time-display"
                    },
                    { 
                        title: "天氣系統", 
                        text: "天氣會影響你的活動效率。晴朗天氣有利於大多數活動，而雨天和雷暴會降低某些活動的效率，但也會帶來好處，比如更容易獲取水分。",
                        highlight: "#weather-display"
                    },
                    { 
                        title: "基本行動", 
                        text: "底部是你可以執行的行動。讓我們先試試採集資源吧！點擊「採集資源」按鈕來獲取生存所需的基本材料。",
                        highlight: "[data-action='gather']",
                        action: "gather"
                    },
                    { 
                        title: "物品欄", 
                        text: "你獲得了一些資源！點擊「物品欄」查看你收集到的物品。",
                        highlight: "[data-action='inventory']",
                        action: "inventory"
                    },
                    { 
                        title: "製作工具", 
                        text: "接下來，讓我們嘗試製作工具。工具可以提高相關活動的效率。點擊「製作工具」按鈕。",
                        highlight: "[data-action='craft']",
                        action: "craft"
                    },
                    { 
                        title: "任務系統", 
                        text: "查看右側的任務面板。完成任務可以獲得獎勵並推進遊戲。點擊「查看任務」按鈕查看更多任務詳情。",
                        highlight: "#quest-info",
                        action: "quest"
                    },
                    { 
                        title: "休息與睡覺", 
                        text: "「休息」可以恢復能量但消耗時間。「結束一天」則會讓你睡覺到第二天早上5點。請根據情況合理安排。",
                        highlight: "[data-action='sleep']"
                    },
                    { 
                        title: "教學完畢", 
                        text: "基本教學已完成！現在你可以開始你的生存冒險了。記得保持飢餓和口渴度，收集資源，完成任務。祝你好運！",
                        highlight: null
                    }
                ]
            },
            quests: [
                {
                    name: "生存基礎",
                    description: "學習基本的生存技能，收集資源以製作工具",
                    type: "GATHER",
                    status: "IN_PROGRESS",
                    requiredItems: { "木頭": 5, "漿果": 3 },
                    requiredFoodStorage: 0,
                    rewards: { "木頭": 3, "石頭": 3, "繩子": 2 }
                },
                {
                    name: "基本工具",
                    description: "製作你的第一個工具來提高採集效率",
                    type: "CRAFT",
                    status: "NOT_STARTED",
                    requiredTool: "AXE",
                    rewards: { "藥草": 2, "漿果": 5 }
                },
                {
                    name: "食物供應",
                    description: "儲存足夠的食物以度過艱難時期",
                    type: "GATHER",
                    status: "NOT_STARTED",
                    requiredFoodStorage: 15,
                    rewards: { "繩子": 3, "樹葉": 5, "藥草": 2 }
                },
                {
                    name: "探索新地點",
                    description: "探索不同的地點以尋找更多資源與機會",
                    type: "EXPLORE",
                    status: "NOT_STARTED",
                    requiredExplorations: 3,
                    rewards: { "石頭": 5, "藥草": 3 }
                },
                {
                    name: "釣者無憂",
                    description: "製作釣竿並成功釣上3條魚",
                    type: "SPECIFIC",
                    status: "NOT_STARTED",
                    requiredTool: "FISHING_ROD",
                    requiredItems: { "魚": 3 },
                    rewards: { "木頭": 5, "繩子": 3, "石頭": 3 }
                },
                {
                    name: "狩獵大師",
                    description: "製作木矛並成功狩獵獲得3塊肉",
                    type: "SPECIFIC",
                    status: "NOT_STARTED",
                    requiredTool: "SPEAR",
                    requiredItems: { "肉": 3 },
                    rewards: { "藥草": 5, "繩子": 4, "石頭": 5 }
                },
                {
                    name: "完整裝備",
                    description: "同時擁有3種不同的工具",
                    type: "TOOLS",
                    status: "NOT_STARTED",
                    requiredToolCount: 3,
                    rewards: { "木頭": 8, "石頭": 8, "繩子": 5 }
                },
                {
                    name: "水源保障",
                    description: "製作水瓶並保持水分充足3天",
                    type: "WATER",
                    status: "NOT_STARTED",
                    requiredTool: "WATER_BOTTLE",
                    requiredWaterDays: 3,
                    waterTrackDays: 0,
                    rewards: { "藥草": 6, "漿果": 10, "木頭": 5 }
                },
                {
                    name: "探險家",
                    description: "探索全部地點",
                    type: "EXPLORE_ALL",
                    status: "NOT_STARTED",
                    rewards: { "木頭": 10, "石頭": 10, "繩子": 8, "藥草": 8 }
                },
                {
                    name: "漫長旅程",
                    description: "在荒野中存活一段時間，證明自己的生存能力",
                    type: "SURVIVE",
                    status: "NOT_STARTED",
                    requiredDays: 15,
                    rewards: { "木頭": 15, "石頭": 15, "繩子": 10, "藥草": 10 }
                }
            ],
            currentQuestIndex: 0,
            tools: {
                AXE: { name: "石斧", description: "用於更有效地採集木材", efficiency: 30, durability: 15 },
                PICKAXE: { name: "石鎬", description: "用於挖掘石頭和礦物", efficiency: 30, durability: 15 },
                FISHING_ROD: { name: "釣竿", description: "用於更有效地釣魚", efficiency: 40, durability: 10 },
                SPEAR: { name: "木矛", description: "用於更有效地狩獵", efficiency: 35, durability: 12 },
                WATER_BOTTLE: { name: "樹葉水瓶", description: "可以儲存水", efficiency: 25, durability: 5 },
                TORCH: { name: "火把", description: "照明用，也可以用於驅趕野獸", efficiency: 20, durability: 8 }
            },
            recipes: [
                {
                    toolType: "AXE",
                    name: "石斧",
                    description: "用於更有效地採集木材",
                    durability: 15,
                    efficiency: 30,
                    requiredItems: { "木頭": 2, "石頭": 3, "繩子": 1 }
                },
                {
                    toolType: "PICKAXE",
                    name: "石鎬",
                    description: "用於挖掘石頭和礦物",
                    durability: 15,
                    efficiency: 30,
                    requiredItems: { "木頭": 2, "石頭": 4, "繩子": 1 }
                },
                {
                    toolType: "FISHING_ROD",
                    name: "釣竿",
                    description: "用於更有效地釣魚",
                    durability: 10,
                    efficiency: 40,
                    requiredItems: { "木頭": 3, "繩子": 2 }
                },
                {
                    toolType: "SPEAR",
                    name: "木矛",
                    description: "用於更有效地狩獵",
                    durability: 12,
                    efficiency: 35,
                    requiredItems: { "木頭": 3, "石頭": 1, "繩子": 1 }
                },
                {
                    toolType: "WATER_BOTTLE",
                    name: "樹葉水瓶",
                    description: "可以儲存水",
                    durability: 5,
                    efficiency: 25,
                    requiredItems: { "樹葉": 5, "繩子": 2 }
                },
                {
                    toolType: "TORCH",
                    name: "火把",
                    description: "照明用，也可以用於驅趕野獸",
                    durability: 8,
                    efficiency: 20,
                    requiredItems: { "木頭": 1, "樹葉": 3 }
                }
            ],
            items: {
                "木頭": { name: "木頭", description: "可以用於製作工具和生火" },
                "石頭": { name: "石頭", description: "可以用於製作工具" },
                "漿果": { name: "漿果", description: "可以食用，恢復少量飢餓度" },
                "魚": { name: "魚", description: "可以食用，恢復大量飢餓度" },
                "藥草": { name: "藥草", description: "可以製作藥品，恢復健康" },
                "繩子": { name: "繩子", description: "用樹皮製成，用於製作工具" },
                "樹葉": { name: "樹葉", description: "用於製作簡易物品" },
                "肉": { name: "肉", description: "可以食用，恢復大量飢餓度" }
            },
            gameCompleted: false,
            waterDaysTracker: 0
        };
        
        // DOM 元素
        const elements = {
            output: document.getElementById('output'),
            userInput: document.getElementById('user-input'),
            submitBtn: document.getElementById('submit-btn'),
            healthValue: document.getElementById('health-value'),
            hungerValue: document.getElementById('hunger-value'),
            energyValue: document.getElementById('energy-value'),
            waterValue: document.getElementById('water-value'),
            dayDisplay: document.getElementById('day-display'),
            timeDisplay: document.getElementById('time-display'),
            weatherDisplay: document.getElementById('weather-display'),
            weatherEffect: document.getElementById('weather-effect'),
            remainingTime: document.getElementById('remaining-time'),
            locationDisplay: document.getElementById('location-display'),
            currentQuest: document.getElementById('current-quest'),
            questDesc: document.getElementById('quest-desc'),
            questProgress: document.getElementById('quest-progress'),
            healthFill: document.querySelector('.health-fill'),
            hungerFill: document.querySelector('.hunger-fill'),
            energyFill: document.querySelector('.energy-fill'),
            waterFill: document.querySelector('.water-fill'),
            actionButtons: document.querySelectorAll('.action-btn'),
            overlay: document.getElementById('overlay'),
            saveBtn: document.getElementById('save-btn'),
            loadBtn: document.getElementById('load-btn'),
            
            // 彈出菜單
            inventoryMenu: document.getElementById('inventory-menu'),
            inventoryContent: document.getElementById('inventory-content'),
            foodStorage: document.getElementById('food-storage'),
            inventoryClose: document.getElementById('inventory-close'),
            useItemBtn: document.getElementById('use-item-btn'),
            
            useItemMenu: document.getElementById('use-item-menu'),
            useItemContent: document.getElementById('use-item-content'),
            useItemClose: document.getElementById('use-item-close'),
            
            restMenu: document.getElementById('rest-menu'),
            restHours: document.getElementById('rest-hours'),
            restConfirm: document.getElementById('rest-confirm'),
            restClose: document.getElementById('rest-close'),
            
            craftMenu: document.getElementById('craft-menu'),
            craftContent: document.getElementById('craft-content'),
            craftClose: document.getElementById('craft-close'),
            
            exploreMenu: document.getElementById('explore-menu'),
            exploreContent: document.getElementById('explore-content'),
            exploreClose: document.getElementById('explore-close'),
            
            questMenu: document.getElementById('quest-menu'),
            questContent: document.getElementById('quest-content'),
            questClose: document.getElementById('quest-close'),
            
            toolsMenu: document.getElementById('tools-menu'),
            toolsContent: document.getElementById('tools-content'),
            toolsClose: document.getElementById('tools-close'),
            
            helpMenu: document.getElementById('help-menu'),
            helpClose: document.getElementById('help-close'),
            
            nameMenu: document.getElementById('name-menu'),
            playerName: document.getElementById('player-name'),
            nameConfirm: document.getElementById('name-confirm'),
            
            tutorialPopup: document.getElementById('tutorial-popup'),
            tutorialContent: document.getElementById('tutorial-content'),
            tutorialNext: document.getElementById('tutorial-next'),
            tutorialClose: document.getElementById('tutorial-close'),
            
            endGameMenu: document.getElementById('end-game-menu'),
            endGameMessage: document.getElementById('end-game-message'),
            endGameStats: document.getElementById('end-game-stats'),
            restartBtn: document.getElementById('restart-btn')
        };
        
        // 初始化遊戲
        function initGame() {
            // 初始物品
            addItemToInventory("木頭", 3);
            addItemToInventory("漿果", 2);
            addItemToInventory("石頭", 1);
            
            // 隨機選擇一個位置作為起始位置
            game.world.currentLocation = getRandomLocation();
            
            // 隨機天氣
            updateWeather();
            
            updateDisplay();
            updateQuestProgress();
            updateWeatherEffectDisplay();
            
            printMessage("遊戲開始！你醒來發現自己身處" + game.world.currentLocation + "，必須想辦法生存下去...");
            printMessage("\n查看右側面板了解你的狀態和當前任務。");
            printMessage("提示: 你可以點擊底部的按鈕進行不同活動。");
            
            // 如果教學未完成，啟動教學
            if (!game.tutorial.completed) {
                setTimeout(() => startTutorial(), 1000);
            }
        }
        
        // 啟動教學
        function startTutorial() {
            game.tutorial.active = true;
            game.tutorial.step = 0;
            showTutorialStep();
        }
        
        // 顯示教學步驟
        function showTutorialStep() {
            const step = game.tutorial.steps[game.tutorial.step];
            elements.tutorialContent.innerHTML = `<h4>${step.title}</h4><p>${step.text}</p>`;
            
            // 顯示教學視窗
            showPopup(elements.tutorialPopup);
            
            // 如果有需要高亮的元素
            if (step.highlight) {
                const highlightEl = document.querySelector(step.highlight);
                if (highlightEl) {
                    highlightEl.style.boxShadow = "0 0 0 2px #ffcc00";
                    highlightEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        // 下一步教學
        function nextTutorialStep() {
            // 清除之前的高亮
            const prevStep = game.tutorial.steps[game.tutorial.step];
            if (prevStep.highlight) {
                const highlightEl = document.querySelector(prevStep.highlight);
                if (highlightEl) {
                    highlightEl.style.boxShadow = "";
                }
            }
            
            game.tutorial.step++;
            
            // 檢查是否結束了教學
            if (game.tutorial.step >= game.tutorial.steps.length) {
                game.tutorial.active = false;
                game.tutorial.completed = true;
                hidePopup(elements.tutorialPopup);
                printMessage("\n教學已完成！現在你可以開始自由探索。祝你好運！");
                return;
            }
            
            showTutorialStep();
        }
        
        // 更新顯示
        function updateDisplay() {
            // 更新玩家狀態
            elements.healthValue.textContent = game.player.health + "/100";
            elements.hungerValue.textContent = game.player.hunger + "/100";
            elements.energyValue.textContent = game.player.energy + "/100";
            elements.waterValue.textContent = game.player.water + "/100";
            
            elements.healthFill.style.width = game.player.health + "%";
            elements.hungerFill.style.width = game.player.hunger + "%";
            elements.energyFill.style.width = game.player.energy + "%";
            elements.waterFill.style.width = game.player.water + "%";
            
            // 更新世界信息
            elements.dayDisplay.textContent = "第" + game.world.day + "天";
            elements.timeDisplay.textContent = formatTime(game.world.hour, game.world.minute);
            elements.weatherDisplay.textContent = game.world.weather;
            
            // 計算剩餘白天時間
            const remainingHours = isNightTime() ? 0 : 24 - game.world.hour;
            elements.remainingTime.textContent = remainingHours + "小時";
            
            elements.locationDisplay.textContent = game.world.currentLocation;
            
            // 更新當前任務
            if (game.currentQuestIndex < game.quests.length) {
                const currentQuest = game.quests[game.currentQuestIndex];
                elements.currentQuest.textContent = currentQuest.name;
                elements.questDesc.textContent = currentQuest.description;
            } else {
                elements.currentQuest.textContent = "所有任務已完成";
                elements.questDesc.textContent = "恭喜你完成了所有任務！";
            }
            
            // 禁用夜晚不能使用的按鈕
            toggleNightButtons();
        }
        
        // 更新天氣效果顯示
        function updateWeatherEffectDisplay() {
            let effectText = "";
            
            switch (game.world.weather) {
                case "晴朗":
                    effectText = "陽光明媚的天氣，適合所有活動。";
                    break;
                case "多雲":
                    effectText = "雲層遮蔽，採集效率略微下降。";
                    break;
                case "雨天":
                    effectText = "下雨中，能量消耗增加，但水源更容易尋找。";
                    break;
                case "雷暴":
                    effectText = "雷暴肆虐，能量消耗大幅增加，狩獵和釣魚效率降低。";
                    break;
            }
            
            elements.weatherEffect.textContent = effectText;
        }
        
        // 更新任務進度顯示
        function updateQuestProgress() {
            if (game.currentQuestIndex >= game.quests.length) {
                elements.questProgress.innerHTML = "所有任務已完成！";
                return;
            }
            
            const currentQuest = game.quests[game.currentQuestIndex];
            let progressText = "";
            
            switch (currentQuest.type) {
                case "GATHER":
                    if (currentQuest.requiredItems) {
                        progressText = "進度: ";
                        for (const [itemName, quantity] of Object.entries(currentQuest.requiredItems)) {
                            const current = game.inventory[itemName] || 0;
                            progressText += `${itemName} (${current}/${quantity}), `;
                        }
                        progressText = progressText.slice(0, -2); // 移除末尾的逗號和空格
                    }
                    
                    if (currentQuest.requiredFoodStorage > 0) {
                        if (progressText !== "") progressText += "<br>";
                        const currentFood = getTotalFoodStorage();
                        progressText += `食物儲備: (${currentFood}/${currentQuest.requiredFoodStorage})`;
                    }
                    break;
                    
                case "CRAFT":
                    progressText = "進度: ";
                    const hasTool = game.player.equippedTools[currentQuest.requiredTool] !== undefined;
                    let toolName = getToolChineseName(currentQuest.requiredTool);
                    
                    progressText += `製作${toolName} (${hasTool ? '1' : '0'}/1)`;
                    break;
                    
                case "SURVIVE":
                    progressText = `進度: 生存天數 (${game.world.day}/${currentQuest.requiredDays})`;
                    break;
                    
                case "EXPLORE":
                    progressText = `進度: 探索地點 (${game.player.visitedLocations.length}/${currentQuest.requiredExplorations})`;
                    break;
                    
                case "EXPLORE_ALL":
                    progressText = `進度: 探索全部地點 (${game.player.visitedLocations.length}/${game.world.locations.length})`;
                    break;
                    
                case "SPECIFIC":
                    progressText = "進度: ";
                    // 檢查是否有指定的工具
                    if (currentQuest.requiredTool) {
                        const hasTool = game.player.equippedTools[currentQuest.requiredTool] !== undefined;
                        let toolName = getToolChineseName(currentQuest.requiredTool);
                        progressText += `製作${toolName} (${hasTool ? '1' : '0'}/1), `;
                    }
                    
                    // 檢查是否有指定的物品
                    if (currentQuest.requiredItems) {
                        for (const [itemName, quantity] of Object.entries(currentQuest.requiredItems)) {
                            const current = game.inventory[itemName] || 0;
                            progressText += `${itemName} (${current}/${quantity}), `;
                        }
                    }
                    
                    progressText = progressText.slice(0, -2); // 移除末尾的逗號和空格
                    break;
                    
                case "TOOLS":
                    const toolCount = Object.keys(game.player.equippedTools).length;
                    progressText = `進度: 擁有工具 (${toolCount}/${currentQuest.requiredToolCount})`;
                    break;
                    
                case "WATER":
                    progressText = "進度: ";
                    // 檢查是否有水瓶
                    const hasWaterBottle = game.player.equippedTools[currentQuest.requiredTool] !== undefined;
                    progressText += `製作水瓶 (${hasWaterBottle ? '1' : '0'}/1), `;
                    // 水分充足天數
                    progressText += `水分充足天數 (${currentQuest.waterTrackDays}/${currentQuest.requiredWaterDays})`;
                    break;
            }
            
            elements.questProgress.innerHTML = progressText;
        }
        
        // 獲取工具中文名稱
        function getToolChineseName(toolType) {
            switch (toolType) {
                case "AXE": return "斧頭";
                case "PICKAXE": return "鎬子";
                case "FISHING_ROD": return "釣竿";
                case "SPEAR": return "矛";
                case "WATER_BOTTLE": return "水瓶";
                case "TORCH": return "火把";
                default: return toolType;
            }
        }
        
        // 格式化時間
        function formatTime(hour, minute) {
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }
        
        // 判斷是否為夜晚
        function isNightTime() {
            return (game.world.hour >= 0 && game.world.hour < 5);
        }
        
        // 前進時間
        function advanceTime(hours, minutes = 0) {
            game.world.minute += minutes;
            game.world.hour += hours + Math.floor(game.world.minute / 60);
            game.world.minute %= 60;
            
            if (game.world.hour >= 24) {
                game.world.hour %= 24;
            }
            
            updateDisplay();
            
            // 如果變成夜晚，提示玩家
            if (isNightTime() && (hours > 0 || minutes > 0)) {
                printMessage("\n天黑了，你需要休息到明天早上。");
            }
        }
        
        // 禁用夜晚不能使用的按鈕
        function toggleNightButtons() {
            const isNight = isNightTime();
            const nightDisabledActions = ["gather", "hunt", "fish", "water", "craft", "explore"];
            
            elements.actionButtons.forEach(button => {
                const action = button.getAttribute("data-action");
                if (nightDisabledActions.includes(action)) {
                    if (isNight) {
                        button.disabled = true;
                        button.style.opacity = "0.5";
                    } else {
                        button.disabled = false;
                        button.style.opacity = "1";
                    }
                }
            });
        }
        
        // 輸出信息到遊戲控制台
        function printMessage(message) {
            elements.output.textContent += "\n" + message;
            elements.output.scrollTop = elements.output.scrollHeight;
        }
        
        // 顯示彈出菜單
        function showPopup(popup) {
            elements.overlay.style.display = "block";
            popup.style.display = "block";
        }
        
        // 隱藏彈出菜單
        function hidePopup(popup) {
            elements.overlay.style.display = "none";
            popup.style.display = "none";
        }
        
        // 添加物品到庫存
        function addItemToInventory(itemName, quantity = 1) {
            if (game.inventory[itemName]) {
                game.inventory[itemName] += quantity;
            } else {
                game.inventory[itemName] = quantity;
            }
            
            // 更新任務進度
            updateQuestProgress();
        }
        
        // 從庫存中移除物品
        function removeItemFromInventory(itemName, quantity = 1) {
            if (game.inventory[itemName]) {
                game.inventory[itemName] -= quantity;
                if (game.inventory[itemName] <= 0) {
                    delete game.inventory[itemName];
                }
                
                // 更新任務進度
                updateQuestProgress();
                return true;
            }
            return false;
        }
        
        // 檢查是否有足夠的物品
        function hasEnoughItems(itemName, quantity = 1) {
            return game.inventory[itemName] && game.inventory[itemName] >= quantity;
        }
        
        // 獲取食物儲備總量
        function getTotalFoodStorage() {
            let total = 0;
            if (game.inventory["漿果"]) total += game.inventory["漿果"];
            if (game.inventory["魚"]) total += game.inventory["魚"] * 2;
            if (game.inventory["肉"]) total += game.inventory["肉"] * 3;
            return total;
        }
        
        // 更新物品欄顯示
        function updateInventoryDisplay() {
            let content = "";
            
            if (Object.keys(game.inventory).length === 0) {
                content = "<p>物品欄是空的</p>";
            } else {
                content = "<ul style='list-style-type: none; padding: 0;'>";
                for (const [itemName, quantity] of Object.entries(game.inventory)) {
                    const item = game.items[itemName];
                    content += `<li class="menu-item"><b>${itemName}</b> x${quantity} - ${item.description}</li>`;
                }
                content += "</ul>";
            }
            
            elements.inventoryContent.innerHTML = content;
            elements.foodStorage.textContent = getTotalFoodStorage();
        }
        
        // 更新使用物品選單
        function updateUseItemMenu() {
            let content = "<ul style='list-style-type: none; padding: 0;'>";
            let hasItems = false;
            
            if (hasEnoughItems("漿果")) {
                content += `<li class="menu-item available" data-item="漿果">吃漿果 (恢復 15 點飢餓度)</li>`;
                hasItems = true;
            }
            
            if (hasEnoughItems("魚")) {
                content += `<li class="menu-item available" data-item="魚">吃魚 (恢復 30 點飢餓度)</li>`;
                hasItems = true;
            }
            
            if (hasEnoughItems("肉")) {
                content += `<li class="menu-item available" data-item="肉">吃肉 (恢復 40 點飢餓度)</li>`;
                hasItems = true;
            }
            
            if (hasEnoughItems("藥草")) {
                content += `<li class="menu-item available" data-item="藥草">使用藥草 (恢復 20 點健康)</li>`;
                hasItems = true;
            }
            
            content += "</ul>";
            
            if (!hasItems) {
                content = "<p>沒有可以使用的物品</p>";
            }
            
            elements.useItemContent.innerHTML = content;
            
            // 為每個物品添加點擊事件
            const items = elements.useItemContent.querySelectorAll('.menu-item.available');
            items.forEach(item => {
                item.addEventListener('click', () => {
                    const itemName = item.getAttribute('data-item');
                    useItem(itemName);
                    hidePopup(elements.useItemMenu);
                });
            });
        }
        
        // 使用物品
        function useItem(itemName) {
            if (removeItemFromInventory(itemName)) {
                switch (itemName) {
                    case "漿果":
                        game.player.hunger = Math.min(100, game.player.hunger + 15);
                        game.player.energy = Math.min(100, game.player.energy + 5);
                        printMessage("你吃了漿果，飢餓度恢復了 15 點。");
                        break;
                    case "魚":
                        game.player.hunger = Math.min(100, game.player.hunger + 30);
                        game.player.energy = Math.min(100, game.player.energy + 10);
                        printMessage("你吃了魚，飢餓度恢復了 30 點。");
                        break;
                    case "肉":
                        game.player.hunger = Math.min(100, game.player.hunger + 40);
                        game.player.energy = Math.min(100, game.player.energy + 13);
                        printMessage("你吃了肉，飢餓度恢復了 40 點。");
                        break;
                    case "藥草":
                        game.player.health = Math.min(100, game.player.health + 20);
                        printMessage("你使用了藥草，健康恢復了 20 點。");
                        break;
                }
                
                advanceTime(0, 30); // 使用物品消耗0.5小時
                updateDisplay();
                
                // 檢查任務完成情況
                checkQuestCompletion();
            } else {
                printMessage(`你沒有${itemName}`);
            }
        }
        
        // 更新製作工具選單
        function updateCraftMenu() {
            let content = "<ul style='list-style-type: none; padding: 0;'>";
            
            game.recipes.forEach((recipe, index) => {
                let canCraft = true;
                let requiredItems = "";
                
                for (const [itemName, quantity] of Object.entries(recipe.requiredItems)) {
                    const current = game.inventory[itemName] || 0;
                    requiredItems += `${itemName} (${current}/${quantity}), `;
                    if (!hasEnoughItems(itemName, quantity)) {
                        canCraft = false;
                    }
                }
                
                requiredItems = requiredItems.slice(0, -2); // 移除末尾的逗號和空格
                
                content += `<li class="menu-item ${canCraft ? 'available' : 'unavailable'}" data-index="${index}">
                ${recipe.name} - ${recipe.description}
                <br><small>需要: ${requiredItems}</small>
                </li>`;
            });
            
            content += "</ul>";
            elements.craftContent.innerHTML = content;
            
            // 為每個可製作的工具添加點擊事件
            const craftItems = elements.craftContent.querySelectorAll('.menu-item.available');
            craftItems.forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    craftTool(index);
                    hidePopup(elements.craftMenu);
                });
            });
        }
        
        // 製作工具
        function craftTool(recipeIndex) {
            const recipe = game.recipes[recipeIndex];
            
            // 檢查是否有足夠的材料
            let canCraft = true;
            for (const [itemName, quantity] of Object.entries(recipe.requiredItems)) {
                if (!hasEnoughItems(itemName, quantity)) {
                    canCraft = false;
                    break;
                }
            }
            
            if (canCraft) {
                // 消耗材料
                for (const [itemName, quantity] of Object.entries(recipe.requiredItems)) {
                    removeItemFromInventory(itemName, quantity);
                }
                
                // 裝備工具
                game.player.equippedTools[recipe.toolType] = {
                    name: recipe.name,
                    description: recipe.description,
                    durability: recipe.durability,
                    efficiency: recipe.efficiency
                };
                
                printMessage(`你成功製作了 ${recipe.name}!`);
                
                // 提高相應技能
                if (recipe.toolType === "AXE" || recipe.toolType === "PICKAXE") {
                    game.player.skills.gathering = Math.min(10, game.player.skills.gathering + 1);
                } else if (recipe.toolType === "FISHING_ROD") {
                    game.player.skills.fishing = Math.min(10, game.player.skills.fishing + 1);
                } else if (recipe.toolType === "SPEAR") {
                    game.player.skills.hunting = Math.min(10, game.player.skills.hunting + 1);
                }
                
                // 減少飢餓度和口渴度
                game.player.hunger = Math.max(0, game.player.hunger - 5);
                game.player.water = Math.max(0, game.player.water - 5);
                game.player.energy = Math.max(0, game.player.energy - 10);
                
                advanceTime(1); // 製作工具消耗1小時
                
                // 檢查飢餓和口渴狀態
                checkHungerAndThirst();
                
                // 檢查任務完成情況
                checkQuestCompletion();
                updateQuestProgress();
            } else {
                printMessage("你沒有足夠的資源製作這個工具!");
            }
        }
        
        // 更新裝備工具顯示
        function updateToolsDisplay() {
            let content = "";
            
            if (Object.keys(game.player.equippedTools).length === 0) {
                content = "<p>沒有裝備任何工具</p>";
            } else {
                content = "<ul style='list-style-type: none; padding: 0;'>";
                for (const [toolType, tool] of Object.entries(game.player.equippedTools)) {
                    content += `<li class="menu-item">
                    <b>${tool.name}</b> - 耐久度: ${tool.durability}
                    <br><small>${tool.description}</small>
                    </li>`;
                }
                content += "</ul>";
            }
            
            elements.toolsContent.innerHTML = content;
        }
        
        // 更新探索地點選單
        function updateExploreMenu() {
            let content = "<ul style='list-style-type: none; padding: 0;'>";
            
            game.world.locations.forEach((location, index) => {
                const explored = game.player.visitedLocations.includes(location);
                const isCurrent = game.world.currentLocation === location;
                let locationText = location;
                
                if (isCurrent) {
                    locationText += ' [當前位置]';
                } else if (explored) {
                    locationText += ' [已探索]';
                }
                
                content += `<li class="menu-item ${isCurrent ? 'unavailable' : 'available'}" data-index="${index}">
                ${locationText}
                </li>`;
            });
            
            content += "</ul>";
            elements.exploreContent.innerHTML = content;
            
            // 為每個地點添加點擊事件
            const locationItems = elements.exploreContent.querySelectorAll('.menu-item.available');
            locationItems.forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.getAttribute('data-index'));
                    exploreLocation(game.world.locations[index]);
                    hidePopup(elements.exploreMenu);
                });
            });
        }
        
        // 探索地點
        function exploreLocation(location) {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(2)) {
                return;
            }
            
            printMessage(`你向 ${location} 進發...`);
            
            // 能量消耗受天氣影響
            const weatherEffect = game.world.weatherEffects[game.world.weather];
            const energyCost = Math.round(20 * weatherEffect.energyMod);
            game.player.energy = Math.max(0, game.player.energy - energyCost);
            
            // 減少飢餓度和口渴度
            game.player.hunger = Math.max(0, game.player.hunger - 8);
            game.player.water = Math.max(0, game.player.water - 10);
            
            // 記錄探索過的地點
            const alreadyExplored = game.player.visitedLocations.includes(location);
            if (!alreadyExplored) {
                game.player.visitedLocations.push(location);
                // 提高生存技能
                game.player.skills.survival = Math.min(10, game.player.skills.survival + 0.5);
            }
            
            // 設置當前位置
            game.world.currentLocation = location;
            
            advanceTime(2); // 探索消耗2小時
            
            if (!alreadyExplored) {
                printMessage(`你第一次探索 ${location}!`);
                
                // 給予獎勵
                const rewardChance = Math.random() * 100;
                if (rewardChance < 75) { // 75% 獲得獎勵
                    const itemName = getRandomItemName();
                    const quantity = 1 + Math.floor(Math.random() * 3); // 1-3個
                    addItemToInventory(itemName, quantity);
                    printMessage(`你找到了隱藏的資源: ${itemName} x${quantity}!`);
                }
            } else {
                printMessage(`你再次探索 ${location}。這裡的環境看起來很熟悉。`);
                
                // 小概率發現新資源
                const rewardChance = Math.random() * 100;
                if (rewardChance < 30) { // 30% 獲得獎勵
                    const itemName = getRandomItemName();
                    addItemToInventory(itemName, 1);
                    printMessage(`你在這裡發現了一些遺漏的資源: ${itemName} x1!`);
                }
            }
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            updateQuestProgress();
        }
        
        // 更新任務顯示
        function updateQuestDisplay() {
            let content = "";
            
            content = "<ul style='list-style-type: none; padding: 0;'>";
            game.quests.forEach((quest, index) => {
                let status = "";
                switch (quest.status) {
                    case "NOT_STARTED": status = "未開始"; break;
                    case "IN_PROGRESS": status = "進行中"; break;
                    case "COMPLETED": status = "已完成"; break;
                }
                
                content += `<li class="menu-item">
                <b>${index + 1}. ${quest.name}</b> [${status}]
                <br><small>${quest.description}</small>`;
                
                if (quest.status !== "COMPLETED") {
                    content += `<br><small>目標: ${getQuestRequirementsText(quest, true)}</small>`;
                }
                
                if (index === game.currentQuestIndex && quest.status !== "COMPLETED") {
                    content += `<br><small>獎勵: ${getQuestRewardsText(quest)}</small>`;
                }
                
                content += "</li>";
            });
            content += "</ul>";
            
            elements.questContent.innerHTML = content;
        }
        
        // 獲取任務需求文本
        function getQuestRequirementsText(quest, showProgress = false) {
            let text = "";
            
            switch (quest.type) {
                case "GATHER":
                    if (quest.requiredItems && Object.keys(quest.requiredItems).length > 0) {
                        text = "收集: ";
                        for (const [itemName, quantity] of Object.entries(quest.requiredItems)) {
                            const current = showProgress ? (game.inventory[itemName] || 0) : 0;
                            text += `${itemName} ${showProgress ? `(${current}/${quantity})` : `x${quantity}`}, `;
                        }
                        text = text.slice(0, -2); // 移除末尾的逗號和空格
                    }
                    
                    if (quest.requiredFoodStorage > 0) {
                        if (text !== "") text += " 並且 ";
                        const currentFood = showProgress ? getTotalFoodStorage() : 0;
                        text += `擁有至少 ${quest.requiredFoodStorage} 單位的食物儲備 ${showProgress ? `(${currentFood}/${quest.requiredFoodStorage})` : ''}`;
                    }
                    break;
                    
                case "CRAFT":
                    text = "製作: ";
                    const hasTool = showProgress ? (game.player.equippedTools[quest.requiredTool] !== undefined) : false;
                    text += `${getToolChineseName(quest.requiredTool)} ${showProgress ? `(${hasTool ? '1' : '0'}/1)` : ''}`;
                    break;
                    
                case "SURVIVE":
                    const currentDay = showProgress ? game.world.day : 0;
                    text = `生存天數: ${quest.requiredDays}天 ${showProgress ? `(${currentDay}/${quest.requiredDays})` : ''}`;
                    break;
                    
                case "EXPLORE":
                    const exploredCount = showProgress ? game.player.visitedLocations.length : 0;
                    text = `探索不同地點: ${quest.requiredExplorations}個 ${showProgress ? `(${exploredCount}/${quest.requiredExplorations})` : ''}`;
                    break;
                    
                case "EXPLORE_ALL":
                    const allExploredCount = showProgress ? game.player.visitedLocations.length : 0;
                    text = `探索全部地點: ${game.world.locations.length}個 ${showProgress ? `(${allExploredCount}/${game.world.locations.length})` : ''}`;
                    break;
                    
                case "SPECIFIC":
                    text = "";
                    // 檢查工具需求
                    if (quest.requiredTool) {
                        const hasTool = showProgress ? (game.player.equippedTools[quest.requiredTool] !== undefined) : false;
                        text += `製作${getToolChineseName(quest.requiredTool)} ${showProgress ? `(${hasTool ? '1' : '0'}/1)` : ''} 並且 `;
                    }
                    
                    // 檢查物品需求
                    if (quest.requiredItems) {
                        text += "收集: ";
                        for (const [itemName, quantity] of Object.entries(quest.requiredItems)) {
                            const current = showProgress ? (game.inventory[itemName] || 0) : 0;
                            text += `${itemName} ${showProgress ? `(${current}/${quantity})` : `x${quantity}`}, `;
                        }
                        text = text.slice(0, -2); // 移除末尾的逗號和空格
                    }
                    break;
                    
                case "TOOLS":
                    const toolCount = showProgress ? Object.keys(game.player.equippedTools).length : 0;
                    text = `同時擁有 ${quest.requiredToolCount} 種不同工具 ${showProgress ? `(${toolCount}/${quest.requiredToolCount})` : ''}`;
                    break;
                    
                case "WATER":
                    text = "";
                    // 檢查水瓶需求
                    const hasWaterBottle = showProgress ? (game.player.equippedTools["WATER_BOTTLE"] !== undefined) : false;
                    text += `製作水瓶 ${showProgress ? `(${hasWaterBottle ? '1' : '0'}/1)` : ''} 並且 `;
                    
                    // 檢查水分天數
                    const waterDays = showProgress ? quest.waterTrackDays : 0;
                    text += `保持水分充足 ${quest.requiredWaterDays} 天 ${showProgress ? `(${waterDays}/${quest.requiredWaterDays})` : ''}`;
                    break;
            }
            
            return text;
        }
        
        // 獲取任務獎勵文本
        function getQuestRewardsText(quest) {
            let text = "";
            
            if (quest.rewards && Object.keys(quest.rewards).length > 0) {
                for (const [itemName, quantity] of Object.entries(quest.rewards)) {
                    text += `${itemName} x${quantity}, `;
                }
                text = text.slice(0, -2); // 移除末尾的逗號和空格
            } else {
                text = "無";
            }
            
            return text;
        }
        
        // 檢查任務完成情況
        function checkQuestCompletion() {
            if (game.currentQuestIndex >= game.quests.length) {
                if (!game.gameCompleted) {
                    showGameCompleteScreen();
                }
                return;
            }
            
            const currentQuest = game.quests[game.currentQuestIndex];
            if (currentQuest.status === "COMPLETED") {
                return;
            }
            
            let completed = false;
            
            switch (currentQuest.type) {
                case "GATHER":
                    completed = checkGatherQuestCompletion(currentQuest);
                    break;
                    
                case "CRAFT":
                    completed = game.player.equippedTools[currentQuest.requiredTool] !== undefined;
                    break;
                    
                case "SURVIVE":
                    completed = game.world.day >= currentQuest.requiredDays;
                    break;
                    
                case "EXPLORE":
                    completed = game.player.visitedLocations.length >= currentQuest.requiredExplorations;
                    break;
                    
                case "EXPLORE_ALL":
                    completed = game.player.visitedLocations.length >= game.world.locations.length;
                    break;
                    
                case "SPECIFIC":
                    completed = checkSpecificQuestCompletion(currentQuest);
                    break;
                    
                case "TOOLS":
                    completed = Object.keys(game.player.equippedTools).length >= currentQuest.requiredToolCount;
                    break;
                    
                case "WATER":
                    const hasWaterBottle = game.player.equippedTools["WATER_BOTTLE"] !== undefined;
                    completed = hasWaterBottle && currentQuest.waterTrackDays >= currentQuest.requiredWaterDays;
                    break;
            }
            
            if (completed) {
                completeQuest();
            }
        }
        
        // 檢查飢餓和口渴狀態
        function checkHungerAndThirst() {
            // 如果飢餓或口渴程度為0，減少健康值
            if (game.player.hunger <= 0 || game.player.water <= 0) {
                game.player.health = Math.max(0, game.player.health - 5);
                printMessage("你因為過度飢餓或口渴，健康值下降了!");
            }
            
            updateDisplay();
            // 檢查玩家是否死亡
            checkPlayerAlive();
        }
        
        // 檢查收集任務完成情況
        function checkGatherQuestCompletion(quest) {
            // 檢查物品需求
            if (quest.requiredItems) {
                for (const [itemName, quantity] of Object.entries(quest.requiredItems)) {
                    if (!hasEnoughItems(itemName, quantity)) {
                        return false;
                    }
                }
            }
            
            // 檢查食物儲備需求
            if (quest.requiredFoodStorage > 0) {
                if (getTotalFoodStorage() < quest.requiredFoodStorage) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 檢查特定任務完成情況
        function checkSpecificQuestCompletion(quest) {
            // 檢查工具需求
            if (quest.requiredTool && !game.player.equippedTools[quest.requiredTool]) {
                return false;
            }
            
            // 檢查物品需求
            if (quest.requiredItems) {
                for (const [itemName, quantity] of Object.entries(quest.requiredItems)) {
                    if (!hasEnoughItems(itemName, quantity)) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        // 完成任務
        function completeQuest() {
            const currentQuest = game.quests[game.currentQuestIndex];
            currentQuest.status = "COMPLETED";
            
            printMessage(`===== 任務完成! =====`);
            printMessage(`你完成了 "${currentQuest.name}" 任務!`);
            
            // 如果是收集任務，消耗任務所需物品（但不消耗食物儲備）
            if ((currentQuest.type === "GATHER" && currentQuest.requiredFoodStorage === 0) || 
                currentQuest.type === "SPECIFIC") {
                if (currentQuest.requiredItems) {
                    for (const [itemName, quantity] of Object.entries(currentQuest.requiredItems)) {
                        removeItemFromInventory(itemName, quantity);
                    }
                }
            }
            
            // 給予獎勵
            let rewardsText = "獎勵: ";
            for (const [itemName, quantity] of Object.entries(currentQuest.rewards)) {
                addItemToInventory(itemName, quantity);
                rewardsText += `${itemName} x${quantity}, `;
            }
            rewardsText = rewardsText.slice(0, -2);
            printMessage(rewardsText);
            
            // 進入下一個任務
            game.currentQuestIndex++;
            
            if (game.currentQuestIndex < game.quests.length) {
                const nextQuest = game.quests[game.currentQuestIndex];
                nextQuest.status = "IN_PROGRESS";
                
                printMessage(`\n新任務開始: "${nextQuest.name}"`);
                printMessage(`描述: ${nextQuest.description}`);
            } else {
                showGameCompleteScreen();
            }
            
            updateDisplay();
            updateQuestProgress();
        }
        
        // 顯示遊戲完成畫面
        function showGameCompleteScreen() {
            game.gameCompleted = true;
            
            let message = `<p>恭喜你完成了所有任務！你成功地在荒野中生存下來，證明了自己的能力。</p>`;
            message += `<p>雖然你的旅程還可以繼續，但你已經掌握了生存的全部秘訣。</p>`;
            
            let stats = `<p>你的成就：</p>`;
            stats += `<p>生存了 ${game.world.day} 天</p>`;
            stats += `<p>探索了 ${game.player.visitedLocations.length} 個地點</p>`;
            stats += `<p>收集了 ${Object.keys(game.inventory).length} 種物品</p>`;
            stats += `<p>製作了 ${Object.keys(game.player.equippedTools).length} 種工具</p>`;
            stats += `<p>完成了 ${game.quests.length} 個任務</p>`;
            
            elements.endGameMessage.innerHTML = message;
            elements.endGameStats.innerHTML = stats;
            
            showPopup(elements.endGameMenu);
        }
        
        // 檢查是否有足夠的時間進行活動
        function checkTimeForActivity(hoursNeeded) {
            if (isNightTime()) {
                printMessage("現在是凌晨時分，太黑了！你需要休息到明天早上。");
                return false;
            }
            
            const remainingHours = 24 - game.world.hour;
            if (remainingHours < hoursNeeded) {
                printMessage(`今天剩餘時間不足以完成這個活動。需要 ${hoursNeeded} 小時，但只剩 ${remainingHours} 小時。`);
                return false;
            }
            
            return true;
        }
        
        // 隨機選擇一個物品名稱
        function getRandomItemName() {
            const itemNames = Object.keys(game.items);
            return itemNames[Math.floor(Math.random() * itemNames.length)];
        }
        
        // 隨機選擇一個位置
        function getRandomLocation() {
            return game.world.locations[Math.floor(Math.random() * game.world.locations.length)];
        }
        
        // 睡覺到明天早上
        function sleepToNextDay() {
            printMessage("你結束了這一天，準備睡覺到明天早上...");
            
            // 更新玩家狀態 (睡覺)
            game.player.hunger = Math.max(0, game.player.hunger - 15);
            game.player.energy = Math.min(100, game.player.energy + 70);
            game.player.water = Math.max(0, game.player.water - 20);
            
            // 檢查生命值
            if (game.player.hunger <= 0 || game.player.water <= 0) {
                game.player.health = Math.max(0, game.player.health - 15);
                printMessage("你因為過度飢餓或口渴，健康值下降了!");
            } else if (game.player.hunger < 20 || game.player.water < 20) {
                game.player.health = Math.max(0, game.player.health - 5);
                printMessage("你因為飢餓或口渴，健康值輕微下降了。");
            }
            
            // 檢查水分任務
            checkWaterQuestTracker();
            
            // 進入下一天
            game.world.day++;
            game.world.hour = 5;
            game.world.minute = 0;
            
            // 隨機更新天氣
            updateWeather();
            updateWeatherEffectDisplay();
            
            printMessage("新的一天開始了!");
            printMessage(`天數: ${game.world.day}，天氣: ${game.world.weather}`);
            printMessage(`時間: ${formatTime(game.world.hour, game.world.minute)}`);
            
            // 如果是雷暴天氣，有機會自動收集水
            if (game.world.weather === "雷暴") {
                printMessage("雷暴帶來了大量雨水，你自動收集了一些。");
                game.player.water = Math.min(100, game.player.water + 15);
            }
            
            updateDisplay();
            updateQuestProgress();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            
            // 檢查玩家是否死亡
            checkPlayerAlive();
        }
        
        // 檢查水分任務追蹤
        function checkWaterQuestTracker() {
            // 尋找水源保障任務
            const waterQuest = game.quests.find(q => q.type === "WATER" && q.status === "IN_PROGRESS");
            if (waterQuest) {
                // 如果水分充足且有水瓶，則計數增加
                if (game.player.water >= 70 && game.player.equippedTools["WATER_BOTTLE"]) {
                    waterQuest.waterTrackDays++;
                    printMessage(`水分充足！你已連續 ${waterQuest.waterTrackDays} 天保持水分充足。`);
                } else {
                    // 如果水分不足，重置計數
                    waterQuest.waterTrackDays = 0;
                    printMessage("水分不足，水分充足天數已重置。");
                }
                
                // 更新任務進度
                updateQuestProgress();
            }
        }
        
        // 更新天氣
        function updateWeather() {
            const weathers = ["晴朗", "多雲", "雨天", "雷暴"];
            const weights = [50, 30, 15, 5]; // 權重，晴朗機率最高，雷暴最低
            
            let total = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * total;
            let sum = 0;
            
            for (let i = 0; i < weathers.length; i++) {
                sum += weights[i];
                if (random < sum) {
                    game.world.weather = weathers[i];
                    break;
                }
            }
        }
        
        // 檢查玩家是否存活
        function checkPlayerAlive() {
            if (game.player.health <= 0) {
                printMessage("\n你的健康值降到了0，無法繼續生存...");
                printMessage("遊戲結束!");
                printMessage(`你存活了 ${game.world.day} 天.`);
                
                // 顯示遊戲結束畫面
                let message = `<p>你的健康值降到了0，無法繼續生存...</p>
                <p>在這個危險的環境中，你存活了 ${game.world.day} 天。</p>
                <p>下次可以嘗試更好地管理你的健康、飢餓和口渴度。</p>`;
                
                let stats = `<p>你的最終數據：</p>
                <p>存活天數：${game.world.day} 天</p>
                <p>探索地點：${game.player.visitedLocations.length} 個</p>
                <p>完成任務：${game.quests.filter(q => q.status === "COMPLETED").length} 個</p>`;
                
                elements.endGameMessage.innerHTML = message;
                elements.endGameStats.innerHTML = stats;
                showPopup(elements.endGameMenu);
                
                // 禁用所有動作按鈕
                elements.actionButtons.forEach(button => {
                    button.disabled = true;
                    button.style.opacity = "0.5";
                });
                
                return false;
            }
            return true;
        }
        
        // 採集資源
        function gatherResources() {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(2)) {
                return;
            }
            
            printMessage(`你在${game.world.currentLocation}採集資源...`);
            
            // 能量消耗受天氣影響
            const weatherEffect = game.world.weatherEffects[game.world.weather];
            const energyCost = Math.round(15 * weatherEffect.energyMod);
            game.player.energy = Math.max(0, game.player.energy - energyCost);
            
            // 減少飢餓度和口渴度
            game.player.hunger = Math.max(0, game.player.hunger - 5);
            game.player.water = Math.max(0, game.player.water - 8);
            
            // 記錄探索地點
            if (!game.player.visitedLocations.includes(game.world.currentLocation)) {
                game.player.visitedLocations.push(game.world.currentLocation);
            }
            
            // 使用斧頭可以提高效率
            let efficiencyBonus = 0;
            if (game.player.equippedTools.AXE) {
                const axe = game.player.equippedTools.AXE;
                axe.durability--;
                printMessage("你使用了斧頭，採集效率提高!");
                efficiencyBonus = axe.efficiency;
                
                // 檢查工具是否損壞
                if (axe.durability <= 0) {
                    printMessage(`你的 ${axe.name} 已經損壞!`);
                    delete game.player.equippedTools.AXE;
                    efficiencyBonus = 0;
                }
            }
            
            // 採集效率受天氣和技能影響
            const gatherMod = weatherEffect.gatherMod;
            const skillBonus = game.player.skills.gathering * 5;
            
            // 採集結果
            let foundItems = [];
            const baseResourceCount = 1 + Math.floor(Math.random() * 2); // 基礎資源數量1-2
            const bonusResourceCount = efficiencyBonus > 0 ? Math.floor(Math.random() * 2) : 0; // 工具加成0-1
            let totalResourceCount = Math.ceil((baseResourceCount + bonusResourceCount) * gatherMod);
            totalResourceCount = Math.max(1, totalResourceCount); // 至少1個
            
            // 技能可能提供額外資源
            if (Math.random() * 100 < skillBonus) {
                totalResourceCount += 1;
                printMessage("你的採集技能提供了額外收獲！");
            }
            
            // 產生不同種類的資源
            for (let i = 0; i < totalResourceCount; i++) {
                const itemName = getRandomItemName();
                const quantity = 1;
                addItemToInventory(itemName, quantity);
                foundItems.push({ name: itemName, quantity: quantity });
            }
            
            // 顯示採集結果
            if (foundItems.length > 0) {
                printMessage("你找到了以下資源:");
                foundItems.forEach(item => {
                    printMessage(`- ${item.name} x${item.quantity}`);
                });
            } else {
                printMessage("你什麼都沒找到...");
            }
            
            // 如果是教學模式下的第一步
            if (game.tutorial.active && game.tutorial.step === 3) {
                nextTutorialStep(); // 進入到第四步 (查看物品欄)
            }
            
            advanceTime(2); // 採集消耗2小時
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            updateQuestProgress();
        }
        
        // 狩獵
        function hunt() {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(2)) {
                return;
            }
            
            printMessage(`你在${game.world.currentLocation}狩獵中...`);
            
            // 能量消耗受天氣影響
            const weatherEffect = game.world.weatherEffects[game.world.weather];
            const energyCost = Math.round(25 * weatherEffect.energyMod);
            game.player.energy = Math.max(0, game.player.energy - energyCost);
            
            // 減少飢餓度和口渴度
            game.player.hunger = Math.max(0, game.player.hunger - 10);
            game.player.water = Math.max(0, game.player.water - 12);
            
            // 記錄探索地點
            if (!game.player.visitedLocations.includes(game.world.currentLocation)) {
                game.player.visitedLocations.push(game.world.currentLocation);
            }
            
            // 使用矛可以提高效率
            let efficiencyBonus = 0;
            if (game.player.equippedTools.SPEAR) {
                const spear = game.player.equippedTools.SPEAR;
                spear.durability--;
                printMessage("你使用了矛，狩獵效率提高!");
                efficiencyBonus = spear.efficiency;
                
                // 檢查工具是否損壞
                if (spear.durability <= 0) {
                    printMessage(`你的 ${spear.name} 已經損壞!`);
                    delete game.player.equippedTools.SPEAR;
                    efficiencyBonus = 0;
                }
            }
            
            // 狩獵效率受天氣和技能影響
            const huntMod = weatherEffect.huntMod;
            const skillBonus = game.player.skills.hunting * 4;
            
            const successRate = Math.random() * 100;
            if (successRate < (40 + skillBonus + efficiencyBonus / 2) * huntMod) { // 基本成功率加上工具加成和天氣影響
                const quantity = 1 + (efficiencyBonus > 0 ? Math.floor(Math.random() * 2) : 0); // 有工具時可能多收集1個
                addItemToInventory("肉", quantity);
                printMessage(`狩獵成功! 你獲得了肉 x${quantity}!`);
                
                // 可能獲得額外物品
                if (Math.random() < 0.3) {
                    const extraItem = getRandomItemName();
                    addItemToInventory(extraItem, 1);
                    printMessage(`你還發現了 ${extraItem} x1!`);
                }
            } else {
                printMessage("狩獵失敗...");
                if (weatherEffect.huntMod < 1) {
                    printMessage(`當前的${game.world.weather}天氣使狩獵更加困難。`);
                }
            }
            
            advanceTime(2); // 狩獵消耗2小時
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            updateQuestProgress();
        }
        
        // 釣魚
        function fish() {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(2)) {
                return;
            }
            
            printMessage(`你在${game.world.currentLocation}附近的水源釣魚...`);
            
            // 能量消耗受天氣影響
            const weatherEffect = game.world.weatherEffects[game.world.weather];
            const energyCost = Math.round(10 * weatherEffect.energyMod);
            game.player.energy = Math.max(0, game.player.energy - energyCost);
            
            // 減少飢餓度和口渴度
            game.player.hunger = Math.max(0, game.player.hunger - 8);
            game.player.water = Math.max(0, game.player.water - 5);
            
            // 記錄探索地點
            if (!game.player.visitedLocations.includes(game.world.currentLocation)) {
                game.player.visitedLocations.push(game.world.currentLocation);
            }
            
            // 使用釣竿可以提高效率
            let efficiencyBonus = 0;
            if (game.player.equippedTools.FISHING_ROD) {
                const rod = game.player.equippedTools.FISHING_ROD;
                rod.durability--;
                printMessage("你使用了釣竿，釣魚效率提高!");
                efficiencyBonus = rod.efficiency;
                
                // 檢查工具是否損壞
                if (rod.durability <= 0) {
                    printMessage(`你的 ${rod.name} 已經損壞!`);
                    delete game.player.equippedTools.FISHING_ROD;
                    efficiencyBonus = 0;
                }
            }
            
            // 釣魚效率受天氣和技能影響
            const fishMod = weatherEffect.fishMod;
            const skillBonus = game.player.skills.fishing * 4;
            
            const successRate = Math.random() * 100;
            if (successRate < (60 + skillBonus + efficiencyBonus / 2) * fishMod) { // 基本成功率加上工具加成和天氣影響
                const quantity = 1 + (efficiencyBonus > 0 ? Math.floor(Math.random() * 2) : 0); // 有工具時可能多收集1個
                addItemToInventory("魚", quantity);
                printMessage(`釣魚成功! 你獲得了魚 x${quantity}!`);
                
                // 雨天釣魚額外獎勵
                if (game.world.weather === "雨天" && Math.random() < 0.4) {
                    addItemToInventory("魚", 1);
                    printMessage("雨天使魚更活躍，你額外釣到了1條魚！");
                }
            } else {
                printMessage("釣魚失敗...");
                if (weatherEffect.fishMod < 1 && game.world.weather === "雷暴") {
                    printMessage("雷暴天氣使魚兒受到驚嚇，不太願意上鉤。");
                }
            }
            
            advanceTime(2); // 釣魚消耗2小時
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            updateQuestProgress();
        }
        
        // 尋找水源
        function findWater() {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(1)) {
                return;
            }
            
            printMessage(`你在${game.world.currentLocation}尋找水源...`);
            
            // 能量消耗受天氣影響
            const weatherEffect = game.world.weatherEffects[game.world.weather];
            const energyCost = Math.round(10 * weatherEffect.energyMod);
            game.player.energy = Math.max(0, game.player.energy - energyCost);
            
            // 減少飢餓度
            game.player.hunger = Math.max(0, game.player.hunger - 3);
            
            // 記錄探索地點
            if (!game.player.visitedLocations.includes(game.world.currentLocation)) {
                game.player.visitedLocations.push(game.world.currentLocation);
            }
            
            // 使用水瓶可以提高效率
            let efficiencyBonus = 0;
            if (game.player.equippedTools.WATER_BOTTLE) {
                const bottle = game.player.equippedTools.WATER_BOTTLE;
                bottle.durability--;
                printMessage("你使用了水瓶，可以儲存更多水!");
                efficiencyBonus = bottle.efficiency;
                
                // 檢查工具是否損壞
                if (bottle.durability <= 0) {
                    printMessage(`你的 ${bottle.name} 已經損壞!`);
                    delete game.player.equippedTools.WATER_BOTTLE;
                    efficiencyBonus = 0;
                }
            }
            
            // 尋水效率受天氣影響
            const waterMod = weatherEffect.waterMod;
            const successRate = Math.random() * 100;
            if (successRate < 80 * waterMod) { // 基本成功率受天氣影響
                // 水量受天氣影響
                const baseWaterAmount = 20 + Math.floor(Math.random() * 30);
                const weatherBonus = game.world.weather === "雨天" ? 10 : (game.world.weather === "雷暴" ? 20 : 0);
                const waterAmount = baseWaterAmount + Math.floor(efficiencyBonus / 2) + weatherBonus;
                
                game.player.water = Math.min(100, game.player.water + waterAmount);
                printMessage("你找到了水源並喝了水!");
                printMessage(`你的口渴度恢復了 ${waterAmount} 點.`);
                
                if (weatherBonus > 0) {
                    printMessage(`因為${game.world.weather}天氣，你更容易找到水。`);
                }
                
                // 可能順便發現其他資源
                if (Math.random() < 0.2) {
                    const extraItem = getRandomItemName();
                    addItemToInventory(extraItem, 1);
                    printMessage(`你在水源附近發現了 ${extraItem} x1!`);
                }
            } else {
                printMessage("你沒找到水源...");
            }
            
            advanceTime(1); // 尋找水源消耗1小時
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            // 檢查任務完成情況
            checkQuestCompletion();
            updateQuestProgress();
        }
        
        // 休息
        function rest(hours) {
            // 檢查是否有足夠的時間
            if (!checkTimeForActivity(hours)) {
                return;
            }
            
            printMessage(`你在${game.world.currentLocation}休息了${hours}小時來恢復體力...`);
            
            // 休息恢復能量但消耗食物和水分
            // 能量回復基礎值
            const energyRecovery = hours * 10;
            
            // 天氣影響（在惡劣天氣下休息恢復較少）
            const weatherMod = game.world.weather === "雷暴" ? 0.8 : (game.world.weather === "雨天" ? 0.9 : 1.0);
            const finalEnergyRecovery = Math.round(energyRecovery * weatherMod);
            
            game.player.energy = Math.min(100, game.player.energy + finalEnergyRecovery);
            game.player.hunger = Math.max(0, game.player.hunger - hours * 2);
            game.player.water = Math.max(0, game.player.water - hours * 3);
            
            printMessage(`你的能量回復了 ${finalEnergyRecovery} 點，但消耗了一些食物和水分。`);
            
            if (weatherMod < 1.0) {
                printMessage(`因為${game.world.weather}天氣，休息效果略有降低。`);
            }
            
            advanceTime(hours);
            
            // 檢查飢餓和口渴狀態
            checkHungerAndThirst();
            
            updateDisplay();
            
            // 檢查玩家是否死亡（因為飢餓或口渴）
            checkPlayerAlive();
        }
        
        // 保存遊戲
        function saveGame() {
            try {
                const saveData = JSON.stringify(game);
                localStorage.setItem('wildernessGame', saveData);
                printMessage("遊戲已成功保存！");
            } catch (error) {
                printMessage("保存遊戲時出錯：" + error.message);
            }
        }
        
        // 載入遊戲
        function loadGame() {
            try {
                const saveData = localStorage.getItem('wildernessGame');
                if (saveData) {
                    const loadedGame = JSON.parse(saveData);
                    // 合併載入的數據
                    Object.assign(game, loadedGame);
                    
                    printMessage("遊戲已成功載入！");
                    updateDisplay();
                    updateQuestProgress();
                    updateWeatherEffectDisplay();
                } else {
                    printMessage("沒有找到保存的遊戲數據。");
                }
            } catch (error) {
                printMessage("載入遊戲時出錯：" + error.message);
            }
        }
        
        // 重新開始遊戲
        function restartGame() {
            // 重置遊戲狀態
            game.player = {
                name: game.player.name, // 保留玩家名稱
                health: 100,
                hunger: 100,
                energy: 100,
                water: 100,
                equippedTools: {},
                visitedLocations: [],
                skills: {
                    gathering: 1,
                    hunting: 1,
                    fishing: 1,
                    survival: 1
                }
            };
            
            game.world = {
                day: 1,
                hour: 5,
                minute: 0,
                weather: "晴朗",
                locations: ["森林", "河邊", "山洞", "廢棄小屋", "平原", "湖泊", "山脊", "峽谷"],
                currentLocation: "",
                weatherEffects: game.world.weatherEffects
            };
            
            game.inventory = {};
            game.currentQuestIndex = 0;
            game.gameCompleted = false;
            game.waterDaysTracker = 0;
            
            // 重置所有任務
            game.quests.forEach(quest => {
                quest.status = "NOT_STARTED";
                if (quest.waterTrackDays !== undefined) {
                    quest.waterTrackDays = 0;
                }
            });
            
            // 設置第一個任務為進行中
            game.quests[0].status = "IN_PROGRESS";
            
            hidePopup(elements.endGameMenu);
            elements.output.textContent = ""; // 清空輸出
            
            // 重新啟用按鈕
            elements.actionButtons.forEach(button => {
                button.disabled = false;
                button.style.opacity = "1";
            });
            
            // 初始化遊戲
            initGame();
        }
        
        // 事件監聽器
        function setupEventListeners() {
            // 提交按鈕點擊事件
            elements.submitBtn.addEventListener('click', handleSubmit);
            
            // 輸入框按Enter鍵事件
            elements.userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            });
            
            // 動作按鈕點擊事件
            elements.actionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-action');
                    handleAction(action);
                });
            });
            
            // 各個彈出窗口的關閉按鈕
            elements.inventoryClose.addEventListener('click', () => hidePopup(elements.inventoryMenu));
            elements.useItemClose.addEventListener('click', () => hidePopup(elements.useItemMenu));
            elements.restClose.addEventListener('click', () => hidePopup(elements.restMenu));
            elements.craftClose.addEventListener('click', () => hidePopup(elements.craftMenu));
            elements.exploreClose.addEventListener('click', () => hidePopup(elements.exploreMenu));
            elements.questClose.addEventListener('click', () => hidePopup(elements.questMenu));
            elements.toolsClose.addEventListener('click', () => hidePopup(elements.toolsMenu));
            elements.helpClose.addEventListener('click', () => hidePopup(elements.helpMenu));
            
            // 使用物品按鈕事件
            elements.useItemBtn.addEventListener('click', () => {
                hidePopup(elements.inventoryMenu);
                updateUseItemMenu();
                showPopup(elements.useItemMenu);
            });
            
            // 休息確認按鈕
            elements.restConfirm.addEventListener('click', () => {
                const hours = parseInt(elements.restHours.value);
                if (hours >= 1) {
                    hidePopup(elements.restMenu);
                    rest(hours);
                } else {
                    printMessage("休息時間至少需要1小時");
                }
            });
            
            // 名字確認按鈕
            elements.nameConfirm.addEventListener('click', () => {
                const name = elements.playerName.value.trim();
                if (name) {
                    game.player.name = name;
                    hidePopup(elements.nameMenu);
                    elements.overlay.style.display = "none";
                    initGame();
                } else {
                    alert("請輸入你的名字!");
                }
            });
            
            // 教學按鈕事件
            elements.tutorialNext.addEventListener('click', nextTutorialStep);
            elements.tutorialClose.addEventListener('click', () => {
                game.tutorial.active = false;
                game.tutorial.completed = true;
                hidePopup(elements.tutorialPopup);
                
                // 清除所有高亮
                const prevStep = game.tutorial.steps[game.tutorial.step];
                if (prevStep.highlight) {
                    const highlightEl = document.querySelector(prevStep.highlight);
                    if (highlightEl) {
                        highlightEl.style.boxShadow = "";
                    }
                }
                
                printMessage("\n教學已跳過。祝你好運！");
            });
            
            // 遊戲結束重新開始按鈕
            elements.restartBtn.addEventListener('click', restartGame);
            
            // 保存和載入按鈕
            elements.saveBtn.addEventListener('click', saveGame);
            elements.loadBtn.addEventListener('click', loadGame);
        }
        
        // 處理提交
        function handleSubmit() {
            const input = elements.userInput.value.trim();
            if (input) {
                printMessage(`> ${input}`);
                // 這裡可以添加更多的命令處理邏輯
                elements.userInput.value = "";
            }
        }
        
        // 處理動作
        function handleAction(action) {
            // 如果處於教學模式並且動作不符合當前步驟，則提示玩家
            if (game.tutorial.active) {
                const currentStep = game.tutorial.steps[game.tutorial.step];
                if (currentStep.action && currentStep.action !== action) {
                    printMessage(`教學提示：請點擊「${getActionButtonName(currentStep.action)}」按鈕。`);
                    return;
                }
            }
            
            switch (action) {
                case 'gather':
                    gatherResources();
                    break;
                    
                case 'hunt':
                    hunt();
                    break;
                    
                case 'fish':
                    fish();
                    break;
                    
                case 'water':
                    findWater();
                    break;
                    
                case 'rest':
                    showPopup(elements.restMenu);
                    // 設置最大可休息時間
                    const maxRestHours = isNightTime() ? 0 : 24 - game.world.hour;
                    elements.restHours.max = maxRestHours;
                    if (parseInt(elements.restHours.value) > maxRestHours) {
                        elements.restHours.value = maxRestHours;
                    }
                    break;
                    
                case 'inventory':
                    updateInventoryDisplay();
                    showPopup(elements.inventoryMenu);
                    
                    // 如果是教學模式下的第五步
                    if (game.tutorial.active && game.tutorial.step === 4) {
                        setTimeout(() => {
                            hidePopup(elements.inventoryMenu);
                            nextTutorialStep(); // 進入到第六步 (製作工具)
                        }, 2000);
                    }
                    break;
                    
                case 'craft':
                    updateCraftMenu();
                    showPopup(elements.craftMenu);
                    
                    // 如果是教學模式下的第六步
                    if (game.tutorial.active && game.tutorial.step === 5) {
                        setTimeout(() => {
                            hidePopup(elements.craftMenu);
                            nextTutorialStep(); // 進入到第七步 (查看任務)
                        }, 2000);
                    }
                    break;
                    
                case 'tools':
                    updateToolsDisplay();
                    showPopup(elements.toolsMenu);
                    break;
                    
                case 'quest':
                    updateQuestDisplay();
                    showPopup(elements.questMenu);
                    
                    // 如果是教學模式下的第七步
                    if (game.tutorial.active && game.tutorial.step === 6) {
                        setTimeout(() => {
                            hidePopup(elements.questMenu);
                            nextTutorialStep(); // 進入到第八步 (休息與睡覺)
                        }, 2000);
                    }
                    break;
                    
                case 'explore':
                    updateExploreMenu();
                    showPopup(elements.exploreMenu);
                    break;
                    
                case 'sleep':
                    sleepToNextDay();
                    
                    // 如果是教學模式下的第八步
                    if (game.tutorial.active && game.tutorial.step === 7) {
                        nextTutorialStep(); // 進入到第九步 (教學完畢)
                    }
                    break;
                    
                case 'help':
                    showPopup(elements.helpMenu);
                    break;
            }
        }
        
        // 獲取動作按鈕的顯示名稱
        function getActionButtonName(action) {
            const actionMap = {
                'gather': '採集資源',
                'hunt': '狩獵',
                'fish': '釣魚',
                'water': '尋找水源',
                'rest': '休息',
                'inventory': '物品欄',
                'craft': '製作工具',
                'tools': '已裝備工具',
                'quest': '查看任務',
                'explore': '探索地點',
                'sleep': '結束一天',
                'help': '遊戲教學'
            };
            
            return actionMap[action] || action;
        }
        
        // 初始化
        setupEventListeners();
        elements.overlay.style.display = "block"; // 顯示遮罩
    </script>
</body>
</html>
